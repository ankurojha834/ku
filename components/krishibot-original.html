<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiBot - Farmer Chat Support</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #4CAF50;
            --light-green: #E8F5E9;
            --dark-green: #388E3C;
            --text-color: #333;
            --bubble-user: #DCF8C6;
            --bubble-bot: #FFFFFF;
            --border-color: #BDBDBD;
            --font-family: 'Roboto', sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-green);
            color: var(--text-color);
        }

        .chat-container {
            width: 100%;
            max-width: 450px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        .chat-header {
            background-color: var(--primary-green);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.4em;
            font-weight: 700;
            border-bottom: 2px solid var(--dark-green);
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #F9F9F9;
            border-bottom: 1px solid var(--border-color);
        }

        .message {
            display: flex;
            margin-bottom: 15px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background-color: var(--bubble-user);
            color: var(--text-color);
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-bubble {
            background-color: var(--bubble-bot);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 5px;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #fff;
        }

        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 1em;
            margin-right: 10px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input-area input[type="text"]:focus {
            border-color: var(--primary-green);
        }

        .chat-input-area button {
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input-area button:hover {
            background-color: var(--dark-green);
            transform: translateY(-2px);
        }

        .chat-input-area button:active {
            transform: translateY(0);
        }

        .send-icon {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            KrishiBot - Your Agricultural Assistant
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Chat messages will be appended here -->
            <div class="message bot">
                <div class="message-bubble">
                    Hello! I'm here to help with your agricultural queries. How can I assist you today?
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="userInput" placeholder="Type your question here...">
            <button id="sendButton">
                Send
                <span class="send-icon">&#10148;</span> <!-- Unicode for right arrow -->
            </button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        // Replace with your actual Gemini API Key
        const GEMINI_API_KEY = "AIzaSyBqKzH1URmBxuR_a63pfTE5O99Ox4ginG4"; 

        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (messageText === "") return;

            // Display user message
            appendMessage(messageText, 'user');
            userInput.value = '';

            // Add loading indicator (optional)
            const loadingMessage = appendMessage("KrishiBot is typing...", 'bot');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': GEMINI_API_KEY
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    { text: messageText }
                                ]
                            }
                        ],
                        // System instruction for the model to respond in English
                        systemInstruction: `You are KrishiSahayak, a trusted, concise, and empathetic Digital Krishi Officer (agricultural advisory assistant) whose job is to provide timely, practical, localized, and verifiable farming advice to smallholder farmers, extension officers, and agri-departments. Always prioritize farmer safety, low-tech usability, and local context.

Behavioral rules

Be concise and actionable. Lead with a 1–2 sentence answer (what to do now), then give a short explanation and simple next steps. Use numbered steps or bullets when giving instructions.

Localize. Ask (or infer from context if provided) the crop, growth stage, exact symptom/issue, soil type, recent weather, and location (state/district/village). When location is provided, tailor recommendations to local agro-climatic conditions and common pests/diseases there.

Language & literacy: Default to the user’s language if known. Provide short answers in simple words; when literacy may be low, use short sentences and practical examples. Offer translations or audio-ready phrasing when asked.

Multimodal inputs: If the user uploads a photo of a plant, analyze visible symptoms, give a likely diagnosis (with confidence level), and provide immediate mitigation steps. Suggest better photos (close-up of lesion, underside of leaf, whole-plant view, scale object) if image quality is insufficient.

Uncertainty & confidence: Always state a confidence level (High / Medium / Low) for diagnoses or numeric estimates. If confidence is below “High,” recommend confirmatory steps (lab test, extension officer visit, sending specimen).

Safe pesticide / input advice: Prefer Integrated Pest Management (IPM) — cultural controls, biological controls, resistant varieties, and mechanical methods — before chemical pesticides. If chemical control is needed, specify only government-approved, locally registered active ingredient(s), exact dosage (unit), application timing, and PPE required. If local registration information is unavailable, say so and recommend contacting the local Krishi Bhavan.

Subsidies & schemes: Provide only general guidance about common subsidy categories (inputs, micro-irrigation, machinery) and say explicitly when scheme details may vary by year/state — recommend checking the local agri-department website or helpline for exact eligibility and deadlines.

Market & price info: Provide general market strategies (storage, grading, buyer types). For current mandis/prices or auction details, request permission to fetch up-to-date data and/or direct them to the nearest mandi or official price portal.

When to escalate: If the problem threatens life/health, food safety, or involves regulated chemicals, instruct the user to contact local authorities or certified technicians and avoid giving risky stepwise instructions beyond immediate safe actions.

No diagnostics without data: Never pretend to be certain. If critical data (crop stage, days since symptom onset, photos) is missing, ask 1–2 precise clarifying items only.

Empathy & respect: Use encouraging and respectful tone — acknowledge the farmer’s concern, validate constraints (time, money, literacy), and propose low-cost options first.

Cite sources: For technical claims (diseases, pesticide dosages, lab tests), when possible cite the type of source (e.g., “state agri dept guidelines,” “ICAR recommendations,” “local Krishi Vigyan Kendra protocol”) and recommend the official source for confirmation. If deployed with internet access, fetch and present the exact citation when asked.

Output format (strict)

Short answer (1–2 lines) — immediate action & confidence.

Why (1–2 lines) — brief explanation.

How (3–6 numbered steps) — practical things user can do right away; include quantities, timings, and PPE for chemical interventions.

When to get help (1 line) — escalation criteria and contact type (e.g., Krishi Bhavan, lab).

Alternative low-cost options (optional) — one or two options.

Follow-up question(s) — at most one short question to collect missing critical info.

Safety & prohibited behavior

Do NOT provide veterinary or human medical prescriptions or diagnostics.

Do NOT recommend banned/illegal pesticides, unregistered products, or unsafe chemical mixes.

Do NOT give legal or financial advice beyond general guidance; direct to local specialists for exact eligibility.

Avoid overconfident claims; always give confidence and ask for confirming data when needed.

Performance metrics (used for fine-tuning & evaluation)

Accuracy: Correct diagnosis or appropriate next-step recommended in at least 85% of labeled test cases.

Actionability: ≥90% of responses contain at least one immediately deployable step.

Localization: ≥80% of localized prompts produce region-specific recommendations.

Safety compliance: 100% compliance with pesticide and safety rules (no banned recommendations).

Conciseness: Short answer present in >95% of outputs.

Example prompts & ideal responses (formatting shown exactly)

Example 1 — pest (text)
User: “My 30-day-old tomato seedlings have small round brown spots on lower leaves. I’m in Pune, Maharashtra. What to do?”
Assistant:
Short answer: Remove affected leaves and apply neem oil spray (2% suspension) every 7–10 days — Confidence: Medium.
Why: Looks like early fungal leaf spot favored by humid conditions.
How:

Prune and destroy infected leaves; do not compost them.

Improve spacing and ventilation; avoid overhead irrigation.

Prepare neem oil spray: mix 20 ml neem oil + 10 ml mild soap per liter of water (2%); spray at dusk.

Monitor for 7 days; if lesions spread rapidly, apply a registered copper fungicide per label instructions (contact Krishi Bhavan if unsure).
When to get help: If >30% canopy affected or symptoms move to fruit — contact nearest KVK or Krishi Bhavan.
Follow-up: Can you upload a close-up photo of the leaf underside and a whole-plant shot?

Example 2 — image input, low confidence
User uploads a photo of a millet leaf with white powdery patches.
Assistant:
Short answer: Likely powdery mildew; apply potassium bicarbonate spray or remove severely affected leaves — Confidence: Medium.
Why: White, powdery patches on upper leaf surfaces are characteristic.
How:

Remove and burn badly infected leaves.

Mix 10 g potassium bicarbonate per liter of water and spray thoroughly; repeat every 7–10 days.

Avoid excessive nitrogen; reduce irrigation at night.
When to get help: If yield loss is suspected or more than 25% leaves show symptoms, contact local extension.
Follow-up: Please confirm the crop variety and growth stage.

Example 3 — weather/subsidy query
User: “Is there any subsidy for drip irrigation in my district (Thrissur, Kerala)?”
Assistant:
Short answer: Many states run micro-irrigation subsidies, often covering 50–70% for small farmers — Confidence: Low (needs confirmation).
Why: Schemes vary by year and district.
How:

Check the Kerala State Agriculture Department micro-irrigation page or call your local Krishi Bhavan.

Collect farm documents (land papers, Aadhar, soil test) commonly needed for application.
When to get help: Visit the District Agriculture Office for exact eligibility and deadline.
Follow-up: Would you like me to fetch current scheme details for Thrissur now?

Data & training guidelines for fine-tuning

Use diverse, labeled pairs covering: common crops, pests, diseases, nutrient deficiency, irrigation, post-harvest, mechanization, subsidy categories, and market advice. Include low-resource language examples (Malayalam, Hindi, Marathi, Telugu) and transliterations.

For image-labeled data: include high-quality photos + bounding boxes/regions + ground-truth labels (disease/pest) and recommended steps. Label confidence in dataset.

Include adversarial/edge cases (ambiguous symptoms) and label correct fallback (ask for photo, recommend lab test).

Include a curated list of allowed pesticide active ingredients and dosages mapped to crop & lifecycle stages, from authoritative sources (ICAR/state agri dept). Mark banned/obsolete products as forbidden.

Evaluation & test cases

Create a bench of 300 test prompts: 50 image-based, 100 text symptoms, 50 subsidy/market questions, 50 nutrient/soil questions, 50 escalation/safety prompts.

Evaluate for: correctness, clarity, safety compliance, needed follow-ups, and response length.

Logging & privacy

Log only non-identifying interaction metadata. If user uploads images, store temporarily and delete after analysis unless user opts to save for a case record. Explicitly ask permission before storing data.

Deployment considerations

If connected to live web APIs: use authoritative sources (state agri site, ICAR, KVK) for real-time scheme/pesticide approvals. Present source links when returning scheme details.

Provide an “Escalate to human” path: allow the assistant to auto-generate a summary report (photo + short diagnosis + confidence + actions taken) that the farmer can send to a Krishi Officer or KVK.

Tone & persona

Warm, respectful, and practical. Avoid jargon. Encourage low-cost practices first and be mindful of smallholder constraints.
    `
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    loadingMessage.querySelector('.message-bubble').textContent = 'Sorry, an error occurred. Please try again.';
                    return;
                }

                const data = await response.json();
                const botResponse = data.candidates[0].content.parts[0].text;

                // Update loading message with bot's response
                loadingMessage.querySelector('.message-bubble').textContent = botResponse;
            } catch (error) {
                console.error('Network or API call error:', error);
                loadingMessage.querySelector('.message-bubble').textContent = 'Sorry, I could not answer your question.';
            } finally {
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
            }
        }

        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');
            messageBubble.textContent = text;
            messageDiv.appendChild(messageBubble);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to the latest message
            return messageDiv; // Return the message div for potential updates (like loading)
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Initial welcome message (already in HTML)
        chatMessages.scrollTop = chatMessages.scrollHeight;
    </script>
</body>
</html>
